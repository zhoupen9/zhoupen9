




<!DOCTYPE html>
<html
  lang="en-US"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  
    <meta http-equiv="content-language" content="en-us" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="rgb(255,255,255)" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Configure vm VLAN &middot; Zhou</title>
    <meta name="title" content="Configure vm VLAN &middot; Zhou" />
  
  <meta name="description" content="A personal github page" />
  
  
  
  <link rel="canonical" href="/solution/vm-vlan/" />
  <link rel="alternate" type="application/rss+xml" href="/solution/vm-vlan/index.xml" title="Zhou" />
  
  
  
  
  
  
  
  
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.ec067e3b50018cea2b1506f103813d03e906410fdfe21bcd12eb6bd07303587fb95b1f9e2a62064cb8044eda56fdb566fff31bef7c99fd7e33698ab89634731c.css"
    integrity="sha512-7AZ&#43;O1ABjOorFQbxA4E9A&#43;kGQQ/f4hvNEutr0HMDWH&#43;5Wx&#43;eKmIGTLgETtpW/bVm//Mb73yZ/X4zaYq4ljRzHA=="
  />
  
  
  <script type="text/javascript" src="/js/appearance.min.c6198a5ecbc6c7b35a8568d29315f50cf5d775d4461c515a476359767f1a745c245aa83fa96b0c7d83da976cf77481e1fc29537a2391a53ffe69a991638802e6.js" integrity="sha512-xhmKXsvGx7NahWjSkxX1DPXXddRGHFFaR2NZdn8adFwkWqg/qWsMfYPal2z3dIHh/ClTeiORpT/&#43;aamRY4gC5g=="></script>
  
    
    
    
  
  
    
    
  
  
  
    
    <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.6d78c827ca7bcbf72056dbf698bf9aeb759a08966686187deb23f5949f73eca5f39b461284900cdfc08e2976d99eb80a8663648de778ba2a83e633ae16dbfc25.js" integrity="sha512-bXjIJ8p7y/cgVtv2mL&#43;a63WaCJZmhhh96yP1lJ9z7KXzm0YShJAM38COKXbZnrgKhmNkjed4uiqD5jOuFtv8JQ==" data-copy="Copy" data-copied="Copied"></script>
  
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="Configure vm VLAN" />
<meta property="og:description" content="A personal github page" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/solution/vm-vlan/" /><meta property="og:site_name" content="Zhou" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Configure vm VLAN"/>
<meta name="twitter:description" content="A personal github page"/>

  
  

  
  <meta name="author" content="Congo" />
  
  
  






  
  
  
  


  
  
</head>
<body
    class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400"
          >&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >Zhou</a
  >

      

    </div>
    
    
      <ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row">
        
          
            <li
              class="mb-1 group sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
            >
              
                <a
                  href="/develop/"
                  title="Development"
                  
                  >
                    <span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Develop</span
                    >
                  </a
                >
              
            </li>
          
            <li
              class="mb-1 group sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
            >
              
                <a
                  href="/solution/"
                  title="Solution"
                  
                  >
                    <span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Solution</span
                    >
                  </a
                >
              
            </li>
          
            <li
              class="mb-1 group sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
            >
              
                <a
                  href="/notes/"
                  title="Notes"
                  
                  >
                    <span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Notes</span
                    >
                  </a
                >
              
            </li>
          
            <li
              class="mb-1 group sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
            >
              
                <a
                  href="https://github.com/zhoupen9"
                  title=""
                  target="_blank"
                  >
                    <span
                      class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"
                    >
                      

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


                    </span>
                  </a
                >
              
            </li>
          
            <li
              class="mb-1 group sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
            >
              
                
                
                  <button
                    id="search-button-1"
                    title="Search (/)"
                  >
                    
                      <span
                        class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"
                      >
                        

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


                      </span>
                    
                      <span
                        class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                        ></span
                      >
                    
                  </button>
                
              
            </li>
          
          
        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  
  <header>
    
      <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      >Personal Playground</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/solution/"
      >Solution</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/solution/vm-vlan/"
      >Configure vm VLAN</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Configure vm VLAN</h1>
  </header>
  <section
    class="mt-12 prose flex max-w-full flex-col dark:prose-invert lg:flex-row"
  >
    
      <div class="order-first px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8">
        <div class="toc ltr:pl-5 rtl:pr-5 lg:sticky lg:top-10">
          <details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden"
  >
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"
  >
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">Solution</a>
</li>
<li><a href="#headline-2">Deployment</a>
<ul>
<li><a href="#headline-3">install xmlstarlet</a>
</li>
<li><a href="#headline-4">libvirt hooks</a>
</li>
<li><a href="#headline-5">configure vm VLAN</a>
</li>
</ul>
</li>
</ul>
</nav>
  </div>
</details>

        </div>
      </div>
    
    <div class="min-w-0 min-h-0 max-w-prose grow">
      
<p>
To isolate vm instances, we can assign different VLAN to vm instances. libvirt virt-manager does not
support VLAN configuration yet, we need a solution to configure VLAN for vm instances.</p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Solution
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>Ingo Höft (Ingo@Hoeft-online.de) provides a solution to utilize libvirt hooks to accomplish that task.
The idea requires to configure VLAN in vm instance domain definition, and provides a XSL file to transform
vm instance domain definition to bare VLAN configuration when vm start/stopped in libvirt hooks,
and apply VLAN configurations in those hooks.</p>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  +---------------+       start        +-----------------+      +-------------------------------+     +--------------+
</span></span><span class="line"><span class="cl">  |  virt-manager | -----------------&gt; |  libvirt hooks  | ---&gt; |  transform domain definition  | --&gt; |  apply VLAN  |
</span></span><span class="line"><span class="cl">  +---------------+      stopped       +-----------------+      +-------------------------------+     +--------------+</span></span></code></pre></div>
</div>
<p>
Ingo&#39;s solution apply VLAN for configured vm and it works great. When apply configurations in <code class="verbatim">firewalld</code> in <em>start</em> hook,
and then vm <em>stopped</em>, unused interface zone configuration remains in firewalld. We can store vm network configuration
in a dedicated configuration file and then remove related firewalld configuration in vm <em>stopped</em> hook.</p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Deployment
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<div id="outline-container-headline-3" class="outline-3">
<h3 id="headline-3">
install xmlstarlet
</h3>
<div id="outline-text-headline-3" class="outline-text-3">
<p>To transform vm instance definition, install package</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  sudo apt install xmlstarlet</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-4" class="outline-3">
<h3 id="headline-4">
libvirt hooks
</h3>
<div id="outline-text-headline-4" class="outline-text-3">
<p>Create file <code class="verbatim">/etc/libvirt/hooks/qemu</code>, and make it executable. <code class="verbatim">chmod +x /etc/libvirt/hooks/qemu</code>.
In this hook script, when hook parameter operation is <span style="text-decoration: underline;">start</span>,  run <code class="verbatim">xmlstarlet</code> to transform vm domain definition
to get VLAN configurations and apply those configurations via <code class="verbatim">bridge</code> commands. To support <code class="verbatim">firewalld</code>,
run <code class="verbatim">firewall-cmd</code> to change vm nic interface to specific zone, i.e. trusted and store vm interface in a configuration file.</p>
<p>
when hook parameter operation is <span style="text-decoration: underline;">stopped</span>, read vm interface from configuration file and run <code class="verbatim">firewall-cmd</code>
to remove vm nic interface from specific zone.</p>
<p>
<code class="verbatim">/etc/libvirt/hooks/qemu.xsl</code></p>
<div class="src src-xml">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">  <span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c">&lt;!-- This stylesheet processes the live XML configuration output from a virtual
</span></span></span><span class="line"><span class="cl"><span class="c">       machine managed by libvirt. It transforms the custom metadata information
</span></span></span><span class="line"><span class="cl"><span class="c">       together with attached interfaces and returns a normalized XML with VLAN
</span></span></span><span class="line"><span class="cl"><span class="c">       ids attached to the interface. For further information look at the
</span></span></span><span class="line"><span class="cl"><span class="c">       README file.
</span></span></span><span class="line"><span class="cl"><span class="c">       Author: 2021-01-26 - Ingo Höft (Ingo@Hoeft-online.de)
</span></span></span><span class="line"><span class="cl"><span class="c">       Licence: GPLv3 (https://www.gnu.org/licenses/gpl-3.0.en.html)
</span></span></span><span class="line"><span class="cl"><span class="c">  --&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;xsl:stylesheet</span> <span class="na">version=</span><span class="s">&#34;1.0&#34;</span> <span class="na">xmlns:xsl=</span><span class="s">&#34;http://www.w3.org/1999/XSL/Transform&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:zve=</span><span class="s">&#34;http://hoeft-online.de/libvirt&#34;</span> <span class="na">exclude-result-prefixes=</span><span class="s">&#34;zve&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;xsl:output</span> <span class="na">omit-xml-declaration=</span><span class="s">&#34;yes&#34;</span> <span class="na">indent=</span><span class="s">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">encoding=</span><span class="s">&#34;utf-8&#34;</span> <span class="na">media-type=</span><span class="s">&#34;text/xml&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;xsl:strip-space</span> <span class="na">elements=</span><span class="s">&#34;*&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&#34;text()|@*&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&#34;/domain&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;meta&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;xsl:apply-templates/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/meta&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/xsl:template&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&#39;*&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">&#39;interface[@type=&#34;bridge&#34;]/target&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;iface&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">&#34;_index&#34;</span> <span class="na">select=</span><span class="s">&#34;position()&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;xsl:attribute</span> <span class="na">name=</span><span class="s">&#34;pvid&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;xsl:choose&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;xsl:when</span> <span class="na">test=</span><span class="s">&#34;/*/metadata/zve:instance/zve:iface[$_index]/@pvid != &#39;&#39;&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&#34;/*/metadata/zve:instance/zve:iface[$_index]/@pvid&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/xsl:when&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;xsl:otherwise&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&lt;xsl:text&gt;</span>0<span class="nt">&lt;/xsl:text&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/xsl:otherwise&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;/xsl:choose&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/xsl:attribute&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&#34;@dev&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">&#34;/*/metadata/zve:instance/zve:iface[$_index]/zve:vlan&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;vlan&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;xsl:attribute</span> <span class="na">name=</span><span class="s">&#34;untagged&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&lt;xsl:choose&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;xsl:when</span> <span class="na">test=</span><span class="s">&#34;@untagged=&#39;yes&#39;&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&lt;xsl:text&gt;</span>yes<span class="nt">&lt;/xsl:text&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/xsl:when&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;xsl:otherwise&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&lt;xsl:text&gt;</span>no<span class="nt">&lt;/xsl:text&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/xsl:otherwise&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&lt;/xsl:choose&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/xsl:attribute&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&#34;.&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;/vlan&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/xsl:for-each&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/iface&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/xsl:for-each&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/xsl:template&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c">&lt;!-- vim: set sts=2 sw=2 et autoindent nowrap: --&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/xsl:stylesheet&gt;</span></span></span></code></pre></div>
</div>
<p>
<code class="verbatim">/etc/libvirt/hooks/qemu</code>, in this hook, store vm interface in <code class="verbatim">/etc/firewall/libvirt/qemu/</code> directory, and each running
vm has a dedicated file named as vm&#39;s name in that directory.</p>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  <span class="c1">#!/usr/bin/bash</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># /etc/libvirt/hooks/qemu</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Docs: https://www.libvirt.org/hooks.html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Author: 2021-01-26 - Ingo Höft (Ingo@Hoeft-online.de)</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Licence: GPLv3 (https://www.gnu.org/licenses/gpl-3.0.en.html)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># If you save a modified hook script then do &#39;sudo systemctl restart libvirtd&#39;.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># This script adds VLAN support to interfaces of libvirt guests on start up.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># For more details look at the README file.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Most work is done with the powerful XML transformation of the XML</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># configuration of the guest on stdin with qemu.xsl to get a normalized</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># meta information into $META, for example like this</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># (we need it to understand the script):</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># &lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># &lt;meta&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   &lt;iface pvid=&#34;26&#34;&gt;vnet1</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#     &lt;vlan untagged=&#34;yes&#34;&gt;26&lt;/vlan&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#     &lt;vlan untagged=&#34;no&#34;&gt;50&lt;/vlan&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#     &lt;vlan untagged=&#34;no&#34;&gt;30&lt;/vlan&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   &lt;/iface&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   &lt;iface pvid=&#34;30&#34;&gt;vnet2</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#     &lt;vlan untagged=&#34;yes&#34;&gt;30&lt;/vlan&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#     &lt;vlan untagged=&#34;no&#34;&gt;50&lt;/vlan&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   &lt;/iface&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   &lt;iface pvid=&#34;0&#34;&gt;vnet3&lt;/iface&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># &lt;/meta&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># for DEBUG uncomment/comment next three lines</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#exec 0&lt; start-vdeb11-base02.xml  # for DEBUG: read testfile to stdin</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#BRIDGE=&#34;/usr/bin/echo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">BRIDGE</span><span class="o">=</span><span class="s2">&#34;/usr/sbin/bridge&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># and call it with ./qemu &#34;dummy-vm&#34; &#34;start&#34; &#34;begin&#34; &#34;-&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">XSLFILE</span><span class="o">=</span><span class="s2">&#34;/etc/libvirt/hooks/qemu.xsl&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">XMLPROG</span><span class="o">=</span><span class="s2">&#34;/usr/bin/xmlstarlet&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">FWCMD</span><span class="o">=</span><span class="s2">&#34;/usr/bin/firewall-cmd&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">LOGFILE</span><span class="o">=</span><span class="s2">&#34;/var/log/libvirt/hooks.log&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">FWDIR</span><span class="o">=</span><span class="s2">&#34;/etc/firewall/libvirt/qemu&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">GUEST</span><span class="o">=</span><span class="nv">$1</span>       <span class="c1"># name of guest being started</span>
</span></span><span class="line"><span class="cl">  <span class="nv">OPERATION</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">  <span class="nv">SUB_OPERATION</span><span class="o">=</span><span class="nv">$3</span>
</span></span><span class="line"><span class="cl">  <span class="nv">EXTRA_PARM</span><span class="o">=</span><span class="nv">$4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">#echo &#39;DEBUG: entering qemu.hook&#39; &gt;&amp;2</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$OPERATION</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">      prepare<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">;;</span>
</span></span><span class="line"><span class="cl">      start<span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$SUB_OPERATION</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;begin&#34;</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$EXTRA_PARM</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;-&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">              <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] Error: Unhandled parameter \$3=&#39;</span><span class="nv">$SUB_OPERATION</span><span class="s2">&#39; or \$4=&#39;</span><span class="nv">$EXTRA_PARM</span><span class="s2">&#39; to </span><span class="nv">$0</span><span class="s2"> \$1 \$2 \$3 \$4&#34;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">              <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">          <span class="k">fi</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="o">[[</span> ! -x <span class="s2">&#34;</span><span class="nv">$XMLPROG</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">              <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] Error: </span><span class="nv">$XMLPROG</span><span class="s2"> is not executable&#34;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">              <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">          <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] hook on </span><span class="nv">$1</span><span class="s2"> </span><span class="nv">$2</span><span class="s2"> </span><span class="nv">$3</span><span class="s2"> </span><span class="nv">$4</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LOGFILE</span>
</span></span><span class="line"><span class="cl">          <span class="c1">#cat - &gt;/var/log/libvirt/start-&#34;$1&#34;.xml; exit 1   # get live xml for DEBUG</span>
</span></span><span class="line"><span class="cl">      <span class="nv">XML</span><span class="o">=</span><span class="k">$(</span>cat -<span class="k">)</span>
</span></span><span class="line"><span class="cl">          <span class="c1">#META=$(&#34;$XMLPROG&#34; tr &#34;$XSLFILE&#34; -)</span>
</span></span><span class="line"><span class="cl">          <span class="nv">META</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$XML</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="s2">&#34;</span><span class="nv">$XMLPROG</span><span class="s2">&#34;</span> tr <span class="s2">&#34;</span><span class="nv">$XSLFILE</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] using hook start with </span><span class="nv">$META</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LOGFILE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nb">true</span> &gt; <span class="nv">$FWDIR</span>/<span class="nv">$GUEST</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># loop through interfaces</span>
</span></span><span class="line"><span class="cl">          <span class="nv">IFACE_COUNT</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">          <span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">              <span class="o">((</span>++IFACE_COUNT<span class="o">))</span>
</span></span><span class="line"><span class="cl">              <span class="nv">IFACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$META</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="s2">&#34;</span><span class="nv">$XMLPROG</span><span class="s2">&#34;</span> sel -t -c <span class="s2">&#34;/meta/iface[</span><span class="nv">$IFACE_COUNT</span><span class="s2">]/text()&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="nv">$IFACE</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                  <span class="c1"># finished, no more interfaces available</span>
</span></span><span class="line"><span class="cl">                  <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">              <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> <span class="nv">$IFACE</span> &gt;&gt; <span class="nv">$FWDIR</span>/<span class="nv">$GUEST</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] trun interface </span><span class="nv">$IFACE</span><span class="s2"> flood off&#34;</span> &gt;&gt; <span class="nv">$LOGFILE</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;</span><span class="nv">$BRIDGE</span><span class="s2">&#34;</span> link <span class="nb">set</span> dev <span class="s2">&#34;</span><span class="nv">$IFACE</span><span class="s2">&#34;</span> flood off
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="c1"># delete vid 1 pvid</span>
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] delete vlan vid 1 pvid 1 dev </span><span class="nv">$IFACE</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LOGFILE</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;</span><span class="nv">$BRIDGE</span><span class="s2">&#34;</span> vlan delete vid <span class="m">1</span> pvid <span class="m">1</span> dev <span class="s2">&#34;</span><span class="nv">$IFACE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1"># add iface to firewalld zone &#39;trusted&#39;</span>
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] add interface </span><span class="nv">$IFACE</span><span class="s2"> to firewall &#39;trusted&#39; zone&#34;</span> &gt;&gt; <span class="nv">$LOGFILE</span>
</span></span><span class="line"><span class="cl">          <span class="nv">$FWCMD</span> --zone<span class="o">=</span>trusted --change-interface <span class="nv">$IFACE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="c1"># loop through vlans on one interface</span>
</span></span><span class="line"><span class="cl">              <span class="nv">VLAN_COUNT</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">              <span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">                  <span class="o">((</span>++VLAN_COUNT<span class="o">))</span>
</span></span><span class="line"><span class="cl">                  <span class="nv">VLAN</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$META</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="s2">&#34;</span><span class="nv">$XMLPROG</span><span class="s2">&#34;</span> sel -t -v <span class="s2">&#34;/meta/iface[</span><span class="nv">$IFACE_COUNT</span><span class="s2">]/vlan[</span><span class="nv">$VLAN_COUNT</span><span class="s2">]/text()&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="nv">$VLAN</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                      <span class="c1"># finished, no more vlans available, process next interface</span>
</span></span><span class="line"><span class="cl">                      <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                  <span class="k">else</span>
</span></span><span class="line"><span class="cl">                      <span class="nv">UNTAGGED</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$META</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="s2">&#34;</span><span class="nv">$XMLPROG</span><span class="s2">&#34;</span> sel -t -v <span class="s2">&#34;/meta/iface[</span><span class="nv">$IFACE_COUNT</span><span class="s2">]/vlan[</span><span class="nv">$VLAN_COUNT</span><span class="s2">]/@untagged&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">                      <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$UNTAGGED</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;yes&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">              <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] add vlan vid </span><span class="nv">$VLAN</span><span class="s2"> dev </span><span class="nv">$IFACE</span><span class="s2"> pvid </span><span class="nv">$VLAN</span><span class="s2"> untagged&#34;</span> &gt;&gt; <span class="nv">$LOGFILE</span>
</span></span><span class="line"><span class="cl">                          <span class="s2">&#34;</span><span class="nv">$BRIDGE</span><span class="s2">&#34;</span> vlan add vid <span class="s2">&#34;</span><span class="nv">$VLAN</span><span class="s2">&#34;</span> dev <span class="s2">&#34;</span><span class="nv">$IFACE</span><span class="s2">&#34;</span> pvid <span class="s2">&#34;</span><span class="nv">$VLAN</span><span class="s2">&#34;</span> untagged
</span></span><span class="line"><span class="cl">                      <span class="k">else</span>
</span></span><span class="line"><span class="cl">              <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] add vlan vid </span><span class="nv">$VLAN</span><span class="s2"> dev </span><span class="nv">$IFACE</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LOGFILE</span>
</span></span><span class="line"><span class="cl">                          <span class="s2">&#34;</span><span class="nv">$BRIDGE</span><span class="s2">&#34;</span> vlan add vid <span class="s2">&#34;</span><span class="nv">$VLAN</span><span class="s2">&#34;</span> dev <span class="s2">&#34;</span><span class="nv">$IFACE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                      <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">              <span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">## reload firewalld</span>
</span></span><span class="line"><span class="cl">          <span class="c1">#$FWCMD --reload</span>
</span></span><span class="line"><span class="cl">          <span class="k">done</span>
</span></span><span class="line"><span class="cl">          <span class="p">;;</span>
</span></span><span class="line"><span class="cl">      started<span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">;;</span>
</span></span><span class="line"><span class="cl">      stopped<span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] hook on </span><span class="nv">$1</span><span class="s2"> </span><span class="nv">$2</span><span class="s2"> </span><span class="nv">$3</span><span class="s2"> </span><span class="nv">$4</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LOGFILE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="o">[[</span> ! -f <span class="s2">&#34;</span><span class="nv">$FWDIR</span><span class="s2">/</span><span class="nv">$GUEST</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">          <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">      <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> -r IFACE <span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="nv">$IFACE</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">          <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">          <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] remove </span><span class="nv">$IFACE</span><span class="s2"> from firewalld zone &#39;trusted&#39;&#34;</span> &gt;&gt; <span class="nv">$LOGFILE</span>
</span></span><span class="line"><span class="cl">          <span class="nv">$FWCMD</span> --zone<span class="o">=</span>trusted --remove-interface <span class="nv">$IFACE</span>
</span></span><span class="line"><span class="cl">          <span class="k">done</span> &lt; <span class="s2">&#34;</span><span class="nv">$FWDIR</span><span class="s2">/</span><span class="nv">$GUEST</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      rm -rf <span class="s2">&#34;</span><span class="nv">$FWDIR</span><span class="s2">/</span><span class="nv">$GUEST</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">;;</span>
</span></span><span class="line"><span class="cl">      release<span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">;;</span>
</span></span><span class="line"><span class="cl">      migrate<span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">;;</span>
</span></span><span class="line"><span class="cl">      restore<span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">;;</span>
</span></span><span class="line"><span class="cl">      reconnect<span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">;;</span>
</span></span><span class="line"><span class="cl">      attach<span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">;;</span>
</span></span><span class="line"><span class="cl">      ,*<span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> <span class="s2">&#34;[</span><span class="nv">$GUEST</span><span class="s2">] Error: qemu hook called with unexpected options </span><span class="nv">$*</span><span class="s2">&#34;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">          <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">          <span class="p">;;</span>
</span></span><span class="line"><span class="cl">  <span class="k">esac</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># vim: set sts=4 sw=4 et autoindent nowrap:</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-5" class="outline-3">
<h3 id="headline-5">
configure vm VLAN
</h3>
<div id="outline-text-headline-5" class="outline-text-3">
<p>For a vm requires <em>untagged</em> single VLAN, add configuration in vm instance definition in <code class="verbatim">domain -&gt; metadata</code> section.
Since we defined the xml namespace as <code>zve</code>, xml configuration requirese prefix <code class="verbatim">zve</code>.</p>
<div class="src src-xml">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">  <span class="nt">&lt;zve:instance</span> <span class="na">xmlns:zve=</span><span class="s">&#34;http://hoeft-online.de/libvirt&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;zve:iface</span> <span class="na">pvid=</span><span class="s">&#34;0&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;zve:vlan</span> <span class="na">untagged=</span><span class="s">&#34;yes&#34;</span><span class="nt">&gt;</span>30<span class="nt">&lt;/zve:vlan&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/zve:iface&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/zve:instance&gt;</span></span></span></code></pre></div>
</div>
<p>
For a vm requries multiple VLANs, add configuration</p>
<div class="src src-xml">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">  <span class="nt">&lt;zve:instance</span> <span class="na">xmlns:zve=</span><span class="s">&#34;http://hoeft-online.de/libvirt&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;zve:iface</span> <span class="na">pvid=</span><span class="s">&#34;0&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;zve:iface</span> <span class="na">pvid=</span><span class="s">&#34;0&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;zve:vlan</span> <span class="na">untagged=</span><span class="s">&#34;no&#34;</span><span class="nt">&gt;</span>10<span class="nt">&lt;/zve:vlan&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;zve:vlan</span> <span class="na">untagged=</span><span class="s">&#34;no&#34;</span><span class="nt">&gt;</span>20<span class="nt">&lt;/zve:vlan&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;zve:vlan</span> <span class="na">untagged=</span><span class="s">&#34;no&#34;</span><span class="nt">&gt;</span>30<span class="nt">&lt;/zve:vlan&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/zve:iface&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/zve:instance&gt;</span></span></span></code></pre></div>
</div>
<p>The configuration defines</p>
<ul>
<li>an interface without VLAN</li>
<li>an interface trunk VLAN 10, 20, 30</li>
</ul>
</div>
</div>
</div>
</div>

    </div>
  </section>
  
    <section class="mt-10 prose dark:prose-invert">
      <p class="py-8 border-t">
        <em>There's no articles to list here yet.</em>
      </p>
    </section>
  

        
          <div
            class="pointer-events-none absolute top-[100vh] bottom-0 w-12 ltr:right-0 rtl:left-0"
          >
            <a
              href="#the-top"
              class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main><footer class="py-10 print:hidden">
  
  
    <nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
          <li
            class="mb-1 group ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            
              <a
                href="/tags/"
                title="Tags"
                
                >
                  <span
                    class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                    >Tags</span
                  >
                </a
              >
            
          </li>
        
      </ul>
    </nav>
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            © 2023
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://git.io/hugo-congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    
    
      <div
        class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
      >
        <button id="appearance-switcher-0" type="button" aria-label="appearance switcher">
          <div
            class="flex items-center justify-center w-12 h-12 dark:hidden"
            title="Switch to dark appearance"
          >
            

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


          </div>
          <div
            class="items-center justify-center hidden w-12 h-12 dark:flex"
            title="Switch to light appearance"
          >
            

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


          </div>
        </button>
      </div>
    
  </div>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url=""
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
</html>
